<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Override auth_signup fields template with our custom fields -->
        <template id="auth_signup_fields_custom" inherit_id="auth_signup.fields" primary="True">
            <xpath expr="//div[hasclass('mb-3')]" position="replace">
                <!-- Name Fields Row -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3 field-first-name">
                            <label for="first_name">First Name</label>
                            <input type="text" name="first_name" id="first_name" class="form-control form-control-sm" 
                                   placeholder="e.g. John" required="required" autofocus="autofocus"/>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3 field-last-name">
                            <label for="last_name">Last Name</label>
                            <input type="text" name="last_name" id="last_name" class="form-control form-control-sm" 
                                   placeholder="e.g. Doe" required="required"/>
                        </div>
                    </div>
                </div>

                <!-- Email Field -->
                <div class="mb-3 field-login">
                    <label for="login">Email Address</label>
                    <input type="email" name="login" t-att-value="login" id="login" class="form-control form-control-sm" 
                           autocapitalize="off" required="required" t-att-readonly="'readonly' if only_passwords else None"/>
                    <div class="invalid-feedback" id="emailError"></div>
                </div>

                <!-- Country Selector -->
                <div class="mb-3 field-phone-country">
                    <label for="phone_country">Phone Country</label>
                    <select class="form-select form-select-sm" id="phone_country" name="phone_country" required="required">
                        <option value="">Select Country</option>
                        <t t-foreach="countries" t-as="country">
                            <option t-att-value="country.id" 
                                    t-att-data-code="country.phone_code"
                                    t-att-selected="'selected' if country.code == 'SA' else None">
                                <t t-esc="country.name"/> (+<t t-esc="country.phone_code"/>)
                            </option>
                        </t>
                    </select>
                </div>

                <!-- Phone Number Field -->
                <div class="mb-3 field-phone">
                    <label for="phone">Phone Number</label>
                    <input type="tel" name="phone" id="phone" class="form-control form-control-sm" 
                           placeholder="Enter without country code" required="required"/>
                    <div class="form-text">
                        Enter your phone number without the country code. We'll add it automatically.
                    </div>
                    <div class="invalid-feedback" id="phoneError"></div>
                </div>

                <!-- Password Field with Toggle -->
                <div class="mb-3 field-password pt-2 position-relative">
                    <label for="password">Password</label>
                    <input type="password" name="password" id="password" class="form-control form-control-sm"
                           required="required" t-att-autofocus="'autofocus' if only_passwords else None"
                           style="padding-right: 2.5rem;"/>
                    <button type="button" class="btn btn-outline-secondary btn-sm position-absolute" 
                            id="togglePassword" style="right: 5px; top: 32px; border: none; background: none;">
                        <i class="fas fa-eye"></i>
                    </button>
                    
                    <!-- Password Strength Indicator -->
                    <div class="password-strength mt-2" id="passwordStrength" style="display: none;">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="strength-text mt-1">
                            <small class="text-muted">Password strength: <span class="strength-label">None</span></small>
                        </div>
                        <div class="requirements-list mt-2" style="display: none;">
                            <small class="text-muted">Requirements:</small>
                            <ul class="requirements small"></ul>
                        </div>
                    </div>
                </div>

                <!-- Confirm Password Field with Toggle -->
                <div class="mb-3 field-confirm-password position-relative">
                    <label for="confirm_password">Confirm Password</label>
                    <input type="password" name="confirm_password" id="confirm_password" class="form-control form-control-sm" 
                           required="required" style="padding-right: 2.5rem;"/>
                    <button type="button" class="btn btn-outline-secondary btn-sm position-absolute" 
                            id="toggleConfirmPassword" style="right: 5px; top: 32px; border: none; background: none;">
                        <i class="fas fa-eye"></i>
                    </button>
                    <div class="invalid-feedback" id="confirmPasswordError"></div>
                </div>
            </xpath>
        </template>

        <!-- Override auth_signup template to use our custom controller -->
        <template id="auth_signup_custom" inherit_id="auth_signup.signup" primary="True">
            <xpath expr="//form[@class='oe_signup_form']" position="attributes">
                <attribute name="action">/j_signup_validation/submit</attribute>
                <attribute name="id">signupForm</attribute>
                <attribute name="novalidate">novalidate</attribute>
            </xpath>
            
            <!-- Add JavaScript and validation rules -->
            <xpath expr="//form[@class='oe_signup_form']" position="after">
                <!-- Pass validation rules to JavaScript -->
                <script type="text/javascript">
                    window.signupValidationRules = {
                        password: <t t-raw="json.dumps(password_rules)"/>,
                        email: <t t-raw="json.dumps(email_rules)"/>,
                        phone: <t t-raw="json.dumps(phone_rules)"/>
                    };
                </script>
                
                <!-- Include JavaScript modules -->
                <script src="/j_signup_validation/static/src/js/password_strength.js"></script>
                <script src="/j_signup_validation/static/src/js/country_phone_selector.js"></script>
                <script src="/j_signup_validation/static/src/js/signup_validation.js"></script>
            </xpath>
        </template>
    </data>
</odoo>